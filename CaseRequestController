public without sharing class CaseRequestController {

    @AuraEnabled(cacheable=true)
    public static User getCurrentUserProfile() {
        String userId = UserInfo.getUserId();
        return [
            SELECT Id, Email, FirstName, LastName, Gender__c, Secondary_Email__c, Birth_Date__c,
                   MobilePhone, Phone, Street, City, CountryCode, StateCode, State, PostalCode, 
                   AccountId, ContactId, Country, Name, Roll_No__c, SmallPhotoUrl, Department, Batch__c
            FROM User
            WHERE Id = :userId
            LIMIT 1
        ];
    }

    @AuraEnabled(cacheable=true)
    public static List<PersonEducation> getEducationInfo() {
        User currentUser = [SELECT ContactId FROM User WHERE Id = :UserInfo.getUserId() LIMIT 1];
        if (currentUser.ContactId == null) return new List<PersonEducation>();

        return [
            SELECT Id, AccountId, ContactId, Name, Department__c, Convocation_Year__c, Degree__c, Type__c,
                   Roll_Number__c, Hostel__c, Major__c, Minor__c, University_Name__c, EndDate, Graduation_Year__c
            FROM PersonEducation
            WHERE ContactId = :currentUser.ContactId
        ];
    }

    @AuraEnabled(cacheable=true)
    public static List<PersonEmployment> getProfessionalInfo() {
        User currentUser = [SELECT ContactId FROM User WHERE Id = :UserInfo.getUserId() LIMIT 1];
        if (currentUser.ContactId == null) return new List<PersonEmployment>();

        return [
            SELECT Id, AccountId, RelatedPersonId, Name, Job_Designation__c, Department__c, 
                   Industry__c, Account.LinkedIn__c
            FROM PersonEmployment
            WHERE RelatedPersonId = :currentUser.ContactId
        ];
    }

    // 游리 Updated method with Draft + Edit Draft handling
    @AuraEnabled
    public static Id createCaseRequest(
        String subject,
        String description,
        String type,
        String status,
        String priority,
        String suppliedEmail,
        String suppliedPhone,
        Boolean isDraft,
        Id existingCaseId
    ) {
        try {
            Map<String, String> typeToRecordType = new Map<String, String>{
                'Membership'         => 'Membership',
                'Job Posting'        => 'Job Posting',
                'Guest House'        => 'Guest House',
                'Gate Pass'          => 'Gate Pass',
                'Donation'           => 'Donation',
                'Event Registration' => 'Event Registration',
                'Profile Update'     => 'Profile Update'
            };

            String recordTypeLabel = typeToRecordType.containsKey(type)
                ? typeToRecordType.get(type)
                : 'Profile Update';

            Map<String, Schema.RecordTypeInfo> rtMap = Schema.SObjectType.Case.getRecordTypeInfosByName();
            Id recordTypeId = rtMap.containsKey(recordTypeLabel)
                ? rtMap.get(recordTypeLabel).getRecordTypeId()
                : null;

            if (recordTypeId == null) {
                throw new AuraHandledException('Record Type not found for this Case Type: ' + type);
            }

            // 游리 Determine final status
            String finalStatus = isDraft ? 'Draft' : 'Pending';

            Case caseRecord;
            if (existingCaseId != null) {
                // 游릭 If editing an existing draft
                caseRecord = [
                    SELECT Id, Status 
                    FROM Case 
                    WHERE Id = :existingCaseId 
                    LIMIT 1
                ];

                if (caseRecord.Status == 'Draft') {
                    caseRecord.Subject = subject;
                    caseRecord.Description = description;
                    caseRecord.Type = type;
                    caseRecord.Priority = String.isNotBlank(priority) ? priority : 'Medium';
                    caseRecord.SuppliedEmail = suppliedEmail;
                    caseRecord.SuppliedPhone = suppliedPhone;
                    caseRecord.Status = finalStatus;
                    update caseRecord;
                    return caseRecord.Id;
                } else {
                    throw new AuraHandledException('Cannot update non-draft requests.');
                }
            } else {
                // 游릭 Create new Case record
                Case newCase = new Case(
                    Subject       = subject,
                    Description   = description,
                    Type          = type,
                    Status        = finalStatus,
                    Priority      = String.isNotBlank(priority) ? priority : 'Medium',
                    SuppliedEmail = suppliedEmail,
                    SuppliedPhone = suppliedPhone,
                    RecordTypeId  = recordTypeId,
                    Origin        = 'Portal'
                );

                insert newCase;
                return newCase.Id;
            }

        } catch (Exception e) {
            throw new AuraHandledException('Error creating or updating request: ' + e.getMessage());
        }
    }

    @AuraEnabled(cacheable=true)
    public static Id getRecordTypeIdByType(String typeName) {
        try {
            Map<String, String> typeToRecordTypeMap = new Map<String, String>{
                'Membership'         => 'Membership',
                'Job Posting'        => 'Job Posting',
                'Guest House'        => 'Guest House',
                'Gate Pass'          => 'Gate Pass',
                'Donation'           => 'Donation',
                'Event Registration' => 'Event Registration',
                'Profile Update'     => 'Profile Update'
            };

            String recordTypeName = typeToRecordTypeMap.get(typeName);

            if (String.isBlank(recordTypeName)) {
                throw new AuraHandledException('No Record Type mapping found for Case Type: ' + typeName);
            }

            RecordType rt = [
                SELECT Id 
                FROM RecordType 
                WHERE SObjectType = 'Case' AND Name = :recordTypeName 
                LIMIT 1
            ];

            return rt.Id;

        } catch (Exception e) {
            throw new AuraHandledException('Error fetching RecordTypeId: ' + e.getMessage());
        }
    }

    @AuraEnabled(cacheable=true)
    public static List<Case> getCasesByRecordType(String recordTypeName) {
        String userId = UserInfo.getUserId();
        List<Case> caseList;

        String baseQuery =
            'SELECT Id, CaseNumber, RecordType.Name, CreatedDate, LastModifiedDate,' +
            ' Subject, Status, Priority, Description, Type, First_Name__c, Last_Name__c,' +
            ' SuppliedEmail, SuppliedPhone, Address__City__s, Address__CountryCode__s, Address__Street__s,' +
            ' Address__StateCode__s, Address__PostalCode__s, Primary_Email__c, Secondary_Email__c, Batch__c,' +
            ' Birth_Date__c, Department__c, Gender__c, Mobile__c, Student_ID__c' +
            ' FROM Case WHERE CreatedById = :userId ';

        if (String.isBlank(recordTypeName) || recordTypeName == 'All Requests' || recordTypeName == 'Profile Update') {
            caseList = Database.query(baseQuery + 'ORDER BY CreatedDate DESC');
        } else {
            caseList = Database.query(baseQuery + 'AND RecordType.Name = :recordTypeName ORDER BY CreatedDate DESC');
        }

        return caseList;
    }

    @AuraEnabled
    public static void linkFilesToCase(String caseId, List<String> contentDocumentIds) {
        try {
            if (String.isBlank(caseId) || contentDocumentIds == null || contentDocumentIds.isEmpty()) {
                throw new AuraHandledException('Invalid parameters provided');
            }

            List<ContentDocumentLink> links = new List<ContentDocumentLink>();
            for (String docId : contentDocumentIds) {
                links.add(new ContentDocumentLink(
                    ContentDocumentId = docId,
                    LinkedEntityId = caseId,
                    ShareType = 'V',
                    Visibility = 'AllUsers'
                ));
            }

            if (!links.isEmpty()) insert links;

        } catch (Exception e) {
            throw new AuraHandledException('Error linking files: ' + e.getMessage());
        }
    }

    @AuraEnabled
    public static void deleteContentDocument(String contentDocumentId) {
        try {
            if (String.isBlank(contentDocumentId)) {
                throw new AuraHandledException('Invalid document ID');
            }
            delete [SELECT Id FROM ContentDocument WHERE Id = :contentDocumentId LIMIT 1];
        } catch (Exception e) {
            throw new AuraHandledException('Error deleting file: ' + e.getMessage());
        }
    }
}
